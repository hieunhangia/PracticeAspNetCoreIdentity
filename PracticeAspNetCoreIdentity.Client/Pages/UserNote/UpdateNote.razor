@using PracticeAspNetCoreIdentity.Shared.Models.UserNote
@attribute [Route($"{Constants.Route.UpdateNote}/{{NoteId:guid}}")]
<h3>Update Note</h3>

<AuthorizeView>
    <Authorized>
        @if (IsLoadedNoteSuccessfully)
        {
            <EditForm Model="@UpdatingNote" OnValidSubmit="UpdateNoteAsync" Context="_">
                <DataAnnotationsValidator/>
                <div>
                    <label for="name">Name:</label>
                    <InputText id="name" @bind-Value="UpdatingNote.Name"/>
                    <ValidationMessage For="@(() => UpdatingNote.Name)"/>
                </div>
                <div>
                    <label for="content">Content:</label>
                    <InputTextArea id="content" @bind-Value="UpdatingNote.Content"/>
                    <ValidationMessage For="@(() => UpdatingNote.Content)"/>
                </div>
                <button type="submit">Update Note</button>
            </EditForm>
        }
    </Authorized>
    <NotAuthorized>
        <p>You need to be logged in to view this page.</p>
    </NotAuthorized>
</AuthorizeView>

@inject WebApiHttpClient WebApiHttpClient
@inject NavigationManager NavigationManager
@inject IJSRuntime JsRuntime

@code {
    [Parameter] public Guid NoteId { get; set; }

    private readonly CreateUpdateUserNoteRequest UpdatingNote = new()
    {
        Content = string.Empty,
        Name = string.Empty
    };

    private bool IsLoadedNoteSuccessfully { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var result = await WebApiHttpClient.GetNoteByIdAsync(NoteId);
        if (result.Succeeded)
        {
            var note = result.Data!;
            UpdatingNote.Name = note.Name ?? string.Empty;
            UpdatingNote.Content = note.Content ?? string.Empty;
            IsLoadedNoteSuccessfully = true;
        }
        else
        {
            await JsRuntime.InvokeVoidAsync("alert", string.Join("\n", result.Errors?.Select(e => $"{e.Key}: {string.Join(", ", e.Value)}") ?? []));
            IsLoadedNoteSuccessfully = false;
        }
    }

    private async Task UpdateNoteAsync()
    {
        var result = await WebApiHttpClient.UpdateNoteAsync(NoteId, UpdatingNote);
        if (result.Succeeded) NavigationManager.NavigateTo(Constants.Route.AllNotes);
        else await JsRuntime.InvokeVoidAsync("alert", string.Join("\n", result.Errors?.Select(e => $"{e.Key}: {string.Join(", ", e.Value)}") ?? []));
    }

}